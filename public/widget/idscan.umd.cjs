(function(o){typeof define=="function"&&define.amd?define(o):o()})((function(){"use strict";function o(e,n){const t=n.width*.7,a=n.height*.4,i=(n.width-t)/2,c=(n.height-a)/2;e.strokeStyle="#00ff99",e.lineWidth=3,e.strokeRect(i,c,t,a)}let d=null;function v(e){const n=w(e);p(e);const t=k(e);return n<60?{ok:!1,message:"Too dark"}:n>220?{ok:!1,message:"Too bright"}:t>25?{ok:!1,message:"Hold still"}:{ok:!0,message:"Hold steady"}}function w(e){let n=0;for(let t=0;t<e.data.length;t+=4)n+=e.data[t];return n/(e.data.length/4)}function p(e){let n=0;for(let t=0;t<e.data.length;t+=4)n+=Math.abs(e.data[t]-e.data[t+4]||0);return n/(e.data.length/4)}function k(e){if(!d)return d=e,0;let n=0;for(let t=0;t<e.data.length;t+=4)n+=Math.abs(e.data[t]-d.data[t]);return d=e,n/(e.data.length/4)}function b(e){return new Promise(n=>{e.toBlob(t=>n(t),"image/jpeg",.85)})}async function I(e,n){const t=new FormData;t.append("image",e),await fetch("https://phyllotaxic-denita-shamefacedly.ngrok-free.dev/api/v1/documents",{method:"POST",headers:{Authorization:`Bearer ${n}`},body:t})}function r(e){const n=document.getElementById("idscan-hint");n.innerText=e}async function S(e){const n=document.getElementById("idscan-root");n.innerHTML=`
    <video playsinline></video>
    <canvas id="overlay"></canvas>
    <canvas id="analysis" style="display:none;"></canvas>
    <div id="idscan-hint">Starting camera...</div>
  `;const t=n.querySelector("video"),a=n.querySelector("#overlay"),i=n.querySelector("#analysis"),c=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment",width:{ideal:1920},height:{ideal:1080}}});t.srcObject=c,await new Promise(u=>t.onloadedmetadata=u),await t.play();function h(){a.width=t.videoWidth,a.height=t.videoHeight,i.width=t.videoWidth,i.height=t.videoHeight}h(),window.addEventListener("resize",h);const g=a.getContext("2d"),m=i.getContext("2d");let l=0,y=0;const B=30;function s(){if(t.readyState!==t.HAVE_ENOUGH_DATA){requestAnimationFrame(s);return}if(y<B){y++,r("Adjusting focus..."),requestAnimationFrame(s);return}m.drawImage(t,0,0,i.width,i.height);const u=m.getImageData(0,0,i.width,i.height),f=v(u);if(r(f.message),g.clearRect(0,0,a.width,a.height),o(g,a),f.ok?l++:l=0,l>45){b(i).then(H=>I(H,e.token)),r("Captured");return}requestAnimationFrame(s)}s()}function A(e,n={}){const t=document.querySelector(e);t.innerHTML=`
    <div id="idscan-placeholder">
      <button id="idscan-start">Start ID Scan</button>
    </div>
    <div id="idscan-root" style="display:none;"></div>
  `,document.getElementById("idscan-start").onclick=()=>{document.getElementById("idscan-placeholder").style.display="none",document.getElementById("idscan-root").style.display="block",S(n)}}window.IdScan={mount:A}}));
